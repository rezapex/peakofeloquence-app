import { createError, defineEventHandler, getQuery } from "h3";
import { withoutBase } from "ufo";
import { extractAndNormaliseOgImageOptions } from "../utils.mjs";
import { getRouteRules } from "#internal/nitro";
import { useRuntimeConfig } from "#imports";
export default defineEventHandler(async (e) => {
  const query = getQuery(e);
  const path = withoutBase(query.path || "/", useRuntimeConfig().app.baseURL);
  let html;
  try {
    html = await globalThis.$fetch(path);
  } catch (err) {
    throw createError({
      statusCode: 500,
      statusMessage: `Failed to read the path ${path} for og-image extraction. ${err.message}.`
    });
  }
  e.node.req.url = path;
  const oldRouteRules = e.context._nitro.routeRules;
  e.context._nitro.routeRules = void 0;
  const routeRules = getRouteRules(e)?.ogImage || {};
  e.context._nitro.routeRules = oldRouteRules;
  e.node.req.url = e.path;
  if (routeRules === false)
    return false;
  const { defaults } = useRuntimeConfig()["nuxt-og-image"];
  const payload = extractAndNormaliseOgImageOptions(path, html, routeRules, defaults);
  if (!payload) {
    throw createError({
      statusCode: 500,
      statusMessage: `The path ${path} is missing the og-image payload.`
    });
  }
  return payload;
});
